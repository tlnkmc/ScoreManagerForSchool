<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:ScoreManagerForSchool.UI.ViewModels"
             xmlns:core="using:ScoreManagerForSchool.Core.Storage"
             x:Class="ScoreManagerForSchool.UI.Views.StatsView"
             x:DataType="vm:StatsViewModel">
  <StackPanel Margin="12" Spacing="8">
    <TextBlock Text="积分统计" FontSize="20" FontWeight="Bold"/>
    <StackPanel Orientation="Horizontal" Spacing="8">
      <Button Content="刷新" Command="{Binding RefreshCommand}"/>
      <Button Content="导出报表" Command="{Binding ExportCommand}"/>
    </StackPanel>

    <!-- 待处理项（最多显示三个） -->
    <StackPanel>
      <TextBlock Text="待处理" FontWeight="SemiBold" Margin="0,6,0,2"/>
      <Border IsVisible="{Binding PendingTop.Count, Converter={StaticResource EqualsConverter}, ConverterParameter=0}" Padding="8" BorderBrush="#DDD" BorderThickness="1" CornerRadius="6">
        <TextBlock Text="暂无数据" Foreground="#888"/>
      </Border>
      <ItemsControl ItemsSource="{Binding PendingTop}">
        <ItemsControl.ItemTemplate>
          <DataTemplate x:DataType="core:EvaluationEntry">
            <Grid ColumnDefinitions="160,*,140,Auto,Auto" Margin="0,2">
              <TextBlock Grid.Column="0" Text="{Binding Class}"/>
              <TextBlock Grid.Column="1" Text="{Binding Remark}"/>
              <TextBlock Grid.Column="2" Text="{Binding Date, StringFormat=yyyy-MM-dd HH:mm}"/>
              <Button Grid.Column="3" Content="处理" Click="OnProcessPendingClick"/>
              <Button Grid.Column="4" Content="删除" Click="OnDeletePendingClick"/>
            </Grid>
          </DataTemplate>
        </ItemsControl.ItemTemplate>
      </ItemsControl>
    </StackPanel>

    <!-- 汇总表 -->
  <Grid ColumnDefinitions="*" RowDefinitions="Auto,Auto,*" RowSpacing="4" ColumnSpacing="8">
      <StackPanel Orientation="Horizontal" Spacing="12">
        <Button Content="按分数排序" Command="{Binding SortCommand}" CommandParameter="Score"/>
        <Button Content="按班级排序" Command="{Binding SortCommand}" CommandParameter="Class"/>
        <Button Content="按唯一号排序" Command="{Binding SortCommand}" CommandParameter="Id"/>
        <Button Content="按姓名排序" Command="{Binding SortCommand}" CommandParameter="Name"/>
      </StackPanel>
  <Grid Grid.Row="1" ColumnDefinitions="200,220,*,140,100" Margin="0,2" HorizontalAlignment="Stretch">
        <TextBlock Grid.Column="0" Text="班级" FontWeight="SemiBold"/>
        <TextBlock Grid.Column="1" Text="唯一号" FontWeight="SemiBold"/>
        <TextBlock Grid.Column="2" Text="姓名" FontWeight="SemiBold"/>
        <TextBlock Grid.Column="3" Text="累计积分" FontWeight="SemiBold"/>
        <TextBlock Grid.Column="4" Text="记录数" FontWeight="SemiBold"/>
      </Grid>
  <Border Grid.Row="2" IsVisible="{Binding Summary.Count, Converter={StaticResource EqualsConverter}, ConverterParameter=0}" Padding="8" BorderBrush="#DDD" BorderThickness="1" CornerRadius="6" Margin="0,4,0,0">
      <TextBlock Text="暂无数据" Foreground="#888"/>
    </Border>
  <ListBox Grid.Row="2" ItemsSource="{Binding Summary}" Height="360" HorizontalAlignment="Stretch">
        <ListBox.Styles>
          <Style Selector="ListBoxItem">
            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
          </Style>
        </ListBox.Styles>
        <ListBox.ItemTemplate>
          <DataTemplate x:DataType="vm:StatsSummaryItem">
  <Grid ColumnDefinitions="200,220,*,140,100,Auto" Margin="0,2">
              <TextBlock Grid.Column="0" Text="{Binding Class}"/>
              <TextBlock Grid.Column="1" Text="{Binding Id}"/>
              <TextBlock Grid.Column="2" Text="{Binding Name}"/>
              <TextBlock Grid.Column="3" Text="{Binding TotalScore}"/>
      <TextBlock Grid.Column="4" Text="{Binding Count}" HorizontalAlignment="Right"/>
      <StackPanel Grid.Column="5" Orientation="Horizontal" Spacing="6">
        <Button Content="✎" Click="OnEditSummaryClick"/>
        <Button Content="🗑" Click="OnDeleteSummaryClick"/>
      </StackPanel>
            </Grid>
          </DataTemplate>
        </ListBox.ItemTemplate>
  </ListBox>
    </Grid>
  </StackPanel>
</UserControl>
