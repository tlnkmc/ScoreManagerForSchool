<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:ScoreManagerForSchool.UI.ViewModels"
             xmlns:core="using:ScoreManagerForSchool.Core.Storage"
             x:Class="ScoreManagerForSchool.UI.Views.HomeView"
             x:DataType="vm:HomeViewModel">
  <ScrollViewer>
    <StackPanel Margin="12" Spacing="10">
    <Grid ColumnDefinitions="Auto,*,Auto,Auto" ColumnSpacing="12">
      <TextBlock Grid.Column="0" Text="首页" FontSize="20" FontWeight="Bold"/>
      <TextBlock Grid.Column="1"/>
      <ComboBox Grid.Column="2" ItemsSource="{Binding RangeOptions}" SelectedItem="{Binding SelectedRange}" MinWidth="100"/>
      <Button Grid.Column="3" Content="刷新" Command="{Binding RefreshCommand}"/>
    </Grid>

    <!-- KPIs -->
  <Grid ColumnDefinitions="*,*,*,*,*" RowDefinitions="Auto" ColumnSpacing="12">
    <Border Background="#2B579A" Padding="10" CornerRadius="6">
        <StackPanel>
      <TextBlock Text="学生数" Foreground="White"/>
      <TextBlock Text="{Binding StudentCount}" Foreground="White" FontSize="22" FontWeight="SemiBold"/>
        </StackPanel>
      </Border>
    <Border Grid.Column="1" Background="#107C10" Padding="10" CornerRadius="6">
        <StackPanel>
      <TextBlock Text="班级数" Foreground="White"/>
      <TextBlock Text="{Binding ClassCount}" Foreground="White" FontSize="22" FontWeight="SemiBold"/>
        </StackPanel>
      </Border>
    <Border Grid.Column="2" Background="#D83B01" Padding="10" CornerRadius="6">
        <StackPanel>
      <TextBlock Text="待处理项" Foreground="White"/>
      <TextBlock Text="{Binding PendingCount}" Foreground="White" FontSize="22" FontWeight="SemiBold"/>
        </StackPanel>
      </Border>
    <Border Grid.Column="3" Background="#0050EF" Padding="10" CornerRadius="6">
        <StackPanel>
      <TextBlock Text="评价记录" Foreground="White"/>
      <TextBlock Text="{Binding EvaluationCount}" Foreground="White" FontSize="22" FontWeight="SemiBold"/>
        </StackPanel>
      </Border>
    <Border Grid.Column="4" Background="#A80000" Padding="10" CornerRadius="6">
        <StackPanel>
      <TextBlock Text="关键积分" Foreground="White"/>
      <TextBlock Text="{Binding CriticalCount}" Foreground="White" FontSize="22" FontWeight="SemiBold"/>
        </StackPanel>
      </Border>
    </Grid>

    <!-- Critical Score Students -->
    <StackPanel>
  <TextBlock Text="关键积分学生（最多显示 5 条）" FontWeight="SemiBold" Margin="0,10,0,4"/>
      <Border IsVisible="{Binding CriticalStudents.Count, Converter={StaticResource EqualsConverter}, ConverterParameter=0}" Padding="8" BorderBrush="#DDD" BorderThickness="1" CornerRadius="6">
        <TextBlock Text="暂无关键积分学生" Foreground="#888"/>
      </Border>
      <ListBox ItemsSource="{Binding CriticalStudents}" Height="120">
        <ListBox.Styles>
          <Style Selector="ListBoxItem">
            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
          </Style>
        </ListBox.Styles>
        <ListBox.ItemTemplate>
          <DataTemplate x:DataType="vm:StatsSummaryItem">
            <Border CornerRadius="6" Padding="8,6" Margin="0,2">
              <Border.Background>
                <SolidColorBrush Color="{Binding CriticalLevel.Color, Converter={StaticResource StringToColorConverter}}" Opacity="0.15"/>
              </Border.Background>
              <Border.BorderBrush>
                <SolidColorBrush Color="{Binding CriticalLevel.Color, Converter={StaticResource StringToColorConverter}}" Opacity="0.5"/>
              </Border.BorderBrush>
              <Border.BorderThickness>1</Border.BorderThickness>
              <Grid ColumnDefinitions="140,120,*,80,120" ColumnSpacing="8">
                <TextBlock Grid.Column="0" 
                          Text="{Binding Class}" 
                          FontWeight="SemiBold"
                          Foreground="{Binding CriticalLevel.Color, Converter={StaticResource StringToBrushConverter}}"/>
                <TextBlock Grid.Column="1" 
                          Text="{Binding Id}" 
                          Foreground="{Binding CriticalLevel.Color, Converter={StaticResource StringToBrushConverter}}"/>
                <TextBlock Grid.Column="2" 
                          Text="{Binding Name}" 
                          Foreground="{Binding CriticalLevel.Color, Converter={StaticResource StringToBrushConverter}}"/>
                <TextBlock Grid.Column="3" 
                          Text="{Binding TotalScore}" 
                          FontWeight="Bold"
                          Foreground="{Binding CriticalLevel.Color, Converter={StaticResource StringToBrushConverter}}"/>
                <Border Grid.Column="4" 
                        CornerRadius="12" 
                        Padding="8,2"
                        HorizontalAlignment="Center">
                  <Border.Background>
                    <SolidColorBrush Color="{Binding CriticalLevel.Color, Converter={StaticResource StringToColorConverter}}"/>
                  </Border.Background>
                  <TextBlock Text="{Binding CriticalLevel.Name}" 
                            Foreground="White" 
                            FontSize="11" 
                            FontWeight="SemiBold"
                            HorizontalAlignment="Center"/>
                </Border>
              </Grid>
            </Border>
          </DataTemplate>
        </ListBox.ItemTemplate>
      </ListBox>
    </StackPanel>

    <!-- Recent list -->
    <StackPanel>
      <TextBlock Text="最近 8 条记录" FontWeight="SemiBold" Margin="0,6,0,4"/>
      <Border IsVisible="{Binding Recent.Count, Converter={StaticResource EqualsConverter}, ConverterParameter=0}" Padding="8" BorderBrush="#DDD" BorderThickness="1" CornerRadius="6">
        <TextBlock Text="暂无数据" Foreground="#888"/>
      </Border>
    <ListBox ItemsSource="{Binding Recent}" Height="220">
        <ListBox.Styles>
          <Style Selector="ListBoxItem">
            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
          </Style>
        </ListBox.Styles>
        <ListBox.ItemTemplate>
      <DataTemplate x:DataType="core:EvaluationEntry">
            <Grid ColumnDefinitions="140,120,*,90,120" Margin="0,2">
        <TextBlock Grid.Column="0" Text="{Binding Class}"/>
        <TextBlock Grid.Column="1" Text="{Binding StudentId}"/>
        <TextBlock Grid.Column="2" Text="{Binding Name}"/>
        <TextBlock Grid.Column="3" Text="{Binding Score}"/>
        <TextBlock Grid.Column="4" Text="{Binding Date, StringFormat=yyyy-MM-dd HH:mm}"/>
            </Grid>
          </DataTemplate>
        </ListBox.ItemTemplate>
      </ListBox>
    </StackPanel>

  </StackPanel>
  </ScrollViewer>
</UserControl>
