<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:ScoreManagerForSchool.UI.ViewModels"
             xmlns:core="using:ScoreManagerForSchool.Core.Storage"
             x:Class="ScoreManagerForSchool.UI.Views.EvaluationListView"
             x:DataType="vm:EvaluationListViewModel"
             x:Name="Root">

  <Border Padding="12">
    <StackPanel Spacing="8">
      <TextBlock Text="ç§¯åˆ†è®°å½•ç®¡ç†" FontSize="18" FontWeight="Bold"/>

      <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
        <TextBox Width="300" Watermark="æœç´¢ (å§“å/å­¦å·/ç­çº§/å¤‡æ³¨/æ•™å¸ˆ)" Text="{Binding Query, Mode=TwoWay}"/>
        <Button Content="åˆ·æ–°" Command="{Binding RefreshCommand}"/>
        <Button Content="æ·»åŠ è®°å½•" Command="{Binding AddCommand}"/>
      </StackPanel>

      <!-- ç­›é€‰æ¡ä»¶é¢æ¿ -->
      <Border BorderBrush="#DDD" BorderThickness="1" CornerRadius="4" Padding="8">
        <StackPanel Spacing="8">
          <TextBlock Text="ç­›é€‰æ¡ä»¶" FontWeight="SemiBold" FontSize="14"/>
          <StackPanel Orientation="Horizontal" Spacing="12" VerticalAlignment="Center">
            <StackPanel Orientation="Horizontal" Spacing="4">
              <TextBlock Text="ç­çº§:" VerticalAlignment="Center"/>
              <ComboBox Width="120" ItemsSource="{Binding ClassOptions}" SelectedItem="{Binding SelectedClass, Mode=TwoWay}"/>
            </StackPanel>
            <StackPanel Orientation="Horizontal" Spacing="4">
              <TextBlock Text="å¼€å§‹æ—¥æœŸ:" VerticalAlignment="Center"/>
              <DatePicker SelectedDate="{Binding StartDate, Mode=TwoWay}" Width="120"/>
            </StackPanel>
            <StackPanel Orientation="Horizontal" Spacing="4">
              <TextBlock Text="ç»“æŸæ—¥æœŸ:" VerticalAlignment="Center"/>
              <DatePicker SelectedDate="{Binding EndDate, Mode=TwoWay}" Width="120"/>
            </StackPanel>
            <CheckBox Content="ä»…æ˜¾ç¤ºæ‰£åˆ†è®°å½•" IsChecked="{Binding ShowNegativeScoresOnly, Mode=TwoWay}"/>
          </StackPanel>
          <!-- æ—¶é—´å¿«æ·é€‰æ‹© -->
          <StackPanel Orientation="Horizontal" Spacing="8">
            <TextBlock Text="å¿«æ·æ—¶é—´:" VerticalAlignment="Center"/>
            <Button Content="ä»Šå¤©" Click="OnSetToday" Padding="8,2"/>
            <Button Content="æ˜¨å¤©" Click="OnSetYesterday" Padding="8,2"/>
            <Button Content="æœ¬å‘¨" Click="OnSetThisWeek" Padding="8,2"/>
            <Button Content="æœ¬æœˆ" Click="OnSetThisMonth" Padding="8,2"/>
            <Button Content="æ¸…é™¤æ—¶é—´" Click="OnClearDates" Padding="8,2"/>
          </StackPanel>
        </StackPanel>
      </Border>

      <Grid ColumnDefinitions="100,100,120,*,80,100,100,Auto" Margin="0,2">
        <TextBlock Grid.Column="0" Text="æ—¥æœŸ" FontWeight="SemiBold"/>
        <TextBlock Grid.Column="1" Text="ç­çº§" FontWeight="SemiBold"/>
        <TextBlock Grid.Column="2" Text="å­¦å·" FontWeight="SemiBold"/>
        <TextBlock Grid.Column="3" Text="å§“å" FontWeight="SemiBold"/>
        <TextBlock Grid.Column="4" Text="ç§¯åˆ†" FontWeight="SemiBold"/>
        <TextBlock Grid.Column="5" Text="æ•™å¸ˆ" FontWeight="SemiBold"/>
        <TextBlock Grid.Column="6" Text="å¤‡æ³¨" FontWeight="SemiBold"/>
        <TextBlock Grid.Column="7" Text="æ“ä½œ" FontWeight="SemiBold"/>
      </Grid>
      
      <ListBox ItemsSource="{Binding Evaluations}" SelectedItem="{Binding SelectedEvaluation, Mode=TwoWay}" Height="400">
        <ListBox.Styles>
          <Style Selector="ListBoxItem">
            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
          </Style>
        </ListBox.Styles>
        <ListBox.ItemTemplate>
          <DataTemplate x:DataType="core:EvaluationEntry">
            <Grid ColumnDefinitions="100,100,120,*,80,100,100,Auto" Margin="0,2">
              <Grid.Styles>
                <Style Selector="TextBox">
                  <Setter Property="MinWidth" Value="80"/>
                  <Setter Property="FontSize" Value="12"/>
                </Style>
                <Style Selector="TextBlock">
                  <Setter Property="FontSize" Value="12"/>
                  <Setter Property="VerticalAlignment" Value="Center"/>
                </Style>
              </Grid.Styles>
              
              <!-- éžç¼–è¾‘æ¨¡å¼ -->
              <TextBlock Grid.Column="0" Text="{Binding Date, StringFormat=MM-dd HH:mm}">
                <TextBlock.IsVisible>
                  <MultiBinding Converter="{StaticResource EqualsConverter}" ConverterParameter="Not">
                    <Binding Path="#Root.DataContext.EditingId"/>
                    <Binding Path="Id"/>
                  </MultiBinding>
                </TextBlock.IsVisible>
              </TextBlock>
              <TextBlock Grid.Column="1" Text="{Binding Class}">
                <TextBlock.IsVisible>
                  <MultiBinding Converter="{StaticResource EqualsConverter}" ConverterParameter="Not">
                    <Binding Path="#Root.DataContext.EditingId"/>
                    <Binding Path="Id"/>
                  </MultiBinding>
                </TextBlock.IsVisible>
              </TextBlock>
              <TextBlock Grid.Column="2" Text="{Binding StudentId}">
                <TextBlock.IsVisible>
                  <MultiBinding Converter="{StaticResource EqualsConverter}" ConverterParameter="Not">
                    <Binding Path="#Root.DataContext.EditingId"/>
                    <Binding Path="Id"/>
                  </MultiBinding>
                </TextBlock.IsVisible>
              </TextBlock>
              <TextBlock Grid.Column="3" Text="{Binding Name}">
                <TextBlock.IsVisible>
                  <MultiBinding Converter="{StaticResource EqualsConverter}" ConverterParameter="Not">
                    <Binding Path="#Root.DataContext.EditingId"/>
                    <Binding Path="Id"/>
                  </MultiBinding>
                </TextBlock.IsVisible>
              </TextBlock>
              <TextBlock Grid.Column="4" Text="{Binding Score}">
                <TextBlock.IsVisible>
                  <MultiBinding Converter="{StaticResource EqualsConverter}" ConverterParameter="Not">
                    <Binding Path="#Root.DataContext.EditingId"/>
                    <Binding Path="Id"/>
                  </MultiBinding>
                </TextBlock.IsVisible>
              </TextBlock>
              <TextBlock Grid.Column="5" Text="{Binding TeacherName}">
                <TextBlock.IsVisible>
                  <MultiBinding Converter="{StaticResource EqualsConverter}" ConverterParameter="Not">
                    <Binding Path="#Root.DataContext.EditingId"/>
                    <Binding Path="Id"/>
                  </MultiBinding>
                </TextBlock.IsVisible>
              </TextBlock>
              <TextBlock Grid.Column="6" Text="{Binding Remark}" TextTrimming="CharacterEllipsis" MaxWidth="150">
                <TextBlock.IsVisible>
                  <MultiBinding Converter="{StaticResource EqualsConverter}" ConverterParameter="Not">
                    <Binding Path="#Root.DataContext.EditingId"/>
                    <Binding Path="Id"/>
                  </MultiBinding>
                </TextBlock.IsVisible>
              </TextBlock>

              <!-- ç¼–è¾‘æ¨¡å¼ -->
              <DatePicker Grid.Column="0" SelectedDate="{Binding Date, Mode=TwoWay}" FontSize="10">
                <DatePicker.IsVisible>
                  <MultiBinding Converter="{StaticResource EqualsConverter}">
                    <Binding Path="#Root.DataContext.EditingId"/>
                    <Binding Path="Id"/>
                  </MultiBinding>
                </DatePicker.IsVisible>
              </DatePicker>
              <TextBox Grid.Column="1" Text="{Binding Class, Mode=TwoWay}">
                <TextBox.IsVisible>
                  <MultiBinding Converter="{StaticResource EqualsConverter}">
                    <Binding Path="#Root.DataContext.EditingId"/>
                    <Binding Path="Id"/>
                  </MultiBinding>
                </TextBox.IsVisible>
              </TextBox>
              <TextBox Grid.Column="2" Text="{Binding StudentId, Mode=TwoWay}">
                <TextBox.IsVisible>
                  <MultiBinding Converter="{StaticResource EqualsConverter}">
                    <Binding Path="#Root.DataContext.EditingId"/>
                    <Binding Path="Id"/>
                  </MultiBinding>
                </TextBox.IsVisible>
              </TextBox>
              <TextBox Grid.Column="3" Text="{Binding Name, Mode=TwoWay}">
                <TextBox.IsVisible>
                  <MultiBinding Converter="{StaticResource EqualsConverter}">
                    <Binding Path="#Root.DataContext.EditingId"/>
                    <Binding Path="Id"/>
                  </MultiBinding>
                </TextBox.IsVisible>
              </TextBox>
              <TextBox Grid.Column="4" Text="{Binding Score, Mode=TwoWay}">
                <TextBox.IsVisible>
                  <MultiBinding Converter="{StaticResource EqualsConverter}">
                    <Binding Path="#Root.DataContext.EditingId"/>
                    <Binding Path="Id"/>
                  </MultiBinding>
                </TextBox.IsVisible>
              </TextBox>
              <TextBox Grid.Column="5" Text="{Binding TeacherName, Mode=TwoWay}">
                <TextBox.IsVisible>
                  <MultiBinding Converter="{StaticResource EqualsConverter}">
                    <Binding Path="#Root.DataContext.EditingId"/>
                    <Binding Path="Id"/>
                  </MultiBinding>
                </TextBox.IsVisible>
              </TextBox>
              <TextBox Grid.Column="6" Text="{Binding Remark, Mode=TwoWay}">
                <TextBox.IsVisible>
                  <MultiBinding Converter="{StaticResource EqualsConverter}">
                    <Binding Path="#Root.DataContext.EditingId"/>
                    <Binding Path="Id"/>
                  </MultiBinding>
                </TextBox.IsVisible>
              </TextBox>

              <!-- æ“ä½œæŒ‰é’® -->
              <StackPanel Grid.Column="7" Orientation="Horizontal" Spacing="4">
                <!-- éžç¼–è¾‘çŠ¶æ€çš„æŒ‰é’® -->
                <Button Content="âœŽ" FontSize="12" Padding="4,2" Command="{Binding #Root.DataContext.EditCommand}" CommandParameter="{Binding}">
                  <Button.IsVisible>
                    <MultiBinding Converter="{StaticResource EqualsConverter}" ConverterParameter="Not">
                      <Binding Path="#Root.DataContext.EditingId"/>
                      <Binding Path="Id"/>
                    </MultiBinding>
                  </Button.IsVisible>
                </Button>
                <Button Content="ðŸ—‘" FontSize="12" Padding="4,2" Command="{Binding #Root.DataContext.DeleteCommand}" CommandParameter="{Binding}">
                  <Button.IsVisible>
                    <MultiBinding Converter="{StaticResource EqualsConverter}" ConverterParameter="Not">
                      <Binding Path="#Root.DataContext.EditingId"/>
                      <Binding Path="Id"/>
                    </MultiBinding>
                  </Button.IsVisible>
                </Button>
                
                <!-- ç¼–è¾‘çŠ¶æ€çš„æŒ‰é’® -->
                <Button Content="âœ“" FontSize="12" Padding="4,2" Command="{Binding #Root.DataContext.SaveCommand}" CommandParameter="{Binding}">
                  <Button.IsVisible>
                    <MultiBinding Converter="{StaticResource EqualsConverter}">
                      <Binding Path="#Root.DataContext.EditingId"/>
                      <Binding Path="Id"/>
                    </MultiBinding>
                  </Button.IsVisible>
                </Button>
                <Button Content="âœ—" FontSize="12" Padding="4,2" Command="{Binding #Root.DataContext.CancelCommand}">
                  <Button.IsVisible>
                    <MultiBinding Converter="{StaticResource EqualsConverter}">
                      <Binding Path="#Root.DataContext.EditingId"/>
                      <Binding Path="Id"/>
                    </MultiBinding>
                  </Button.IsVisible>
                </Button>
              </StackPanel>
            </Grid>
          </DataTemplate>
        </ListBox.ItemTemplate>
      </ListBox>
    </StackPanel>
  </Border>
</UserControl>
