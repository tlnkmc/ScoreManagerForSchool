<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:ScoreManagerForSchool.UI.ViewModels"
             xmlns:core="using:ScoreManagerForSchool.Core.Storage"
             x:Class="ScoreManagerForSchool.UI.Views.StudentsListView"
             x:DataType="vm:StudentsViewModel"
             x:Name="Root">

  <ScrollViewer>
    <Border Padding="12">
    <StackPanel Spacing="8">
      <TextBlock Text="å­¦ç”Ÿåˆ—è¡¨ç®¡ç†" FontSize="18" FontWeight="Bold"/>

      <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
        <!-- è¾“å…¥æ¡†åœ¨å·¦ï¼Œå³ä¾§ä¾æ¬¡ä¸ºï¼šæµè§ˆã€é¢„è§ˆã€ä¿å­˜ -->
        <TextBox Width="300" Watermark="CSV è·¯å¾„ (students.csv)" Name="CsvPathBox"/>
        <Button Content="æµè§ˆ" Click="OnBrowseCsv" Tag="{Binding #CsvPathBox}"/>
        <Button Content="é¢„è§ˆ" Click="OnPreviewImport"/>
        <Button Content="ä¿å­˜" Click="OnImportAndSave"/>
        <CheckBox Name="HeaderCheck" IsChecked="True" Content="é¦–è¡Œä¸ºè¡¨å¤´" VerticalAlignment="Center"/>
  <Button Content="æ ¼å¼è¯´æ˜Ž" Click="OnShowFormatInfo"/>
        <TextBox Width="240" Watermark="æœç´¢ (å§“å/å­¦å·/ç­çº§)" Text="{Binding Query, Mode=TwoWay}"/>
      </StackPanel>

      <Grid ColumnDefinitions="120, 140, *" Margin="0,2">
        <TextBlock Grid.Column="0" Text="ç­çº§" FontWeight="SemiBold"/>
        <TextBlock Grid.Column="1" Text="å­¦å·" FontWeight="SemiBold"/>
        <TextBlock Grid.Column="2" Text="å§“å" FontWeight="SemiBold"/>
      </Grid>
      <ListBox ItemsSource="{Binding Students}" SelectedItem="{Binding SelectedStudent, Mode=TwoWay}" Height="360">
        <ListBox.ItemTemplate>
          <DataTemplate x:DataType="core:Student">
            <Grid ColumnDefinitions="120, 140, *, Auto" Margin="0,2">
              <Grid.Styles>
                <Style Selector="TextBox">
                  <Setter Property="MinWidth" Value="100"/>
                </Style>
              </Grid.Styles>
              <!-- Row is in edit mode when EditingId == this.Id -->
              <TextBlock Grid.Column="0" Text="{Binding Class}">
                <TextBlock.IsVisible>
                  <MultiBinding Converter="{StaticResource EqualsConverter}" ConverterParameter="Not">
                    <Binding Path="#Root.DataContext.EditingId"/>
                    <Binding Path="Id"/>
                  </MultiBinding>
                </TextBlock.IsVisible>
              </TextBlock>
              <TextBox Grid.Column="0" Text="{Binding Class, Mode=TwoWay}">
                <TextBox.IsVisible>
                  <MultiBinding Converter="{StaticResource EqualsConverter}">
                    <Binding Path="#Root.DataContext.EditingId"/>
                    <Binding Path="Id"/>
                  </MultiBinding>
                </TextBox.IsVisible>
              </TextBox>

              <TextBlock Grid.Column="1" Text="{Binding Id}">
                <TextBlock.IsVisible>
                  <MultiBinding Converter="{StaticResource EqualsConverter}" ConverterParameter="Not">
                    <Binding Path="#Root.DataContext.EditingId"/>
                    <Binding Path="Id"/>
                  </MultiBinding>
                </TextBlock.IsVisible>
              </TextBlock>
              <TextBox Grid.Column="1" Text="{Binding Id, Mode=TwoWay}">
                <TextBox.IsVisible>
                  <MultiBinding Converter="{StaticResource EqualsConverter}">
                    <Binding Path="#Root.DataContext.EditingId"/>
                    <Binding Path="Id"/>
                  </MultiBinding>
                </TextBox.IsVisible>
              </TextBox>

              <TextBlock Grid.Column="2" Text="{Binding Name}">
                <TextBlock.IsVisible>
                  <MultiBinding Converter="{StaticResource EqualsConverter}" ConverterParameter="Not">
                    <Binding Path="#Root.DataContext.EditingId"/>
                    <Binding Path="Id"/>
                  </MultiBinding>
                </TextBlock.IsVisible>
              </TextBlock>
              <TextBox Grid.Column="2" Text="{Binding Name, Mode=TwoWay}">
                <TextBox.IsVisible>
                  <MultiBinding Converter="{StaticResource EqualsConverter}">
                    <Binding Path="#Root.DataContext.EditingId"/>
                    <Binding Path="Id"/>
                  </MultiBinding>
                </TextBox.IsVisible>
              </TextBox>

              <StackPanel Grid.Column="3" Orientation="Horizontal" Spacing="6">
                <!-- show edit/delete when not editing this row -->
                <StackPanel.IsVisible>
                  <MultiBinding Converter="{StaticResource EqualsConverter}" ConverterParameter="Not">
                    <Binding Path="#Root.DataContext.EditingId"/>
                    <Binding Path="Id"/>
                  </MultiBinding>
                </StackPanel.IsVisible>
                <Button Content="âœŽ" Command="{Binding #Root.DataContext.BeginEditCommand}" CommandParameter="{Binding}"/>
                <Button Content="ðŸ—‘" Command="{Binding #Root.DataContext.DeleteRowCommand}" CommandParameter="{Binding}"/>
              </StackPanel>
              <StackPanel Grid.Column="3" Orientation="Horizontal" Spacing="6">
                <!-- show cancel/save when editing this row -->
                <StackPanel.IsVisible>
                  <MultiBinding Converter="{StaticResource EqualsConverter}">
                    <Binding Path="#Root.DataContext.EditingId"/>
                    <Binding Path="Id"/>
                  </MultiBinding>
                </StackPanel.IsVisible>
                <Button Content="Ã—" Command="{Binding #Root.DataContext.CancelEditCommand}" CommandParameter="{Binding}"/>
                <Button Content="âœ”" Command="{Binding #Root.DataContext.SaveRowCommand}" CommandParameter="{Binding}"/>
              </StackPanel>
            </Grid>
          </DataTemplate>
        </ListBox.ItemTemplate>
      </ListBox>

      <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Center">
        <Button Content="ä¸Šä¸€é¡µ" Command="{Binding PrevPageCommand}"/>
        <TextBlock Text="{Binding Page}" VerticalAlignment="Center" Margin="8,0"/>
        <TextBlock Text="/" VerticalAlignment="Center"/>
        <TextBlock Text="{Binding TotalPages}" VerticalAlignment="Center"/>
        <Button Content="ä¸‹ä¸€é¡µ" Command="{Binding NextPageCommand}" Margin="8,0,0,0"/>
      </StackPanel>

  <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Spacing="8">
        <Button Content="åˆ é™¤æ‰€é€‰" Command="{Binding DeleteCommand}"/>
        <Button Content="ä¿å­˜æ‰€é€‰" Command="{Binding SaveEditCommand}"/>
        <Button Content="æ‰¹é‡æ›´æ”¹ç­çº§" Click="OnBulkChangeClass"/>
      </StackPanel>
    </StackPanel>
    </Border>
  </ScrollViewer>

</UserControl>
