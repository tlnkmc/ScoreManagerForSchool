<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:ScoreManagerForSchool.UI.ViewModels"
             xmlns:core="using:ScoreManagerForSchool.Core.Storage"
             x:Class="ScoreManagerForSchool.UI.Views.InfoEntryView"
             x:DataType="vm:InfoEntryViewModel">
  <ScrollViewer>
    <Grid RowDefinitions="Auto,*,Auto,Auto" Margin="12" RowSpacing="8">
      <TextBlock Text="信息录入" FontSize="20" FontWeight="Bold"/>
      
      <StackPanel Grid.Row="1" Spacing="8">
        <TextBlock Text="当前处理："/>
        <TextBox IsReadOnly="True" Text="{Binding CurrentLineText}"/>
  <TextBox Name="PasteBox" AcceptsReturn="True" Height="160" Watermark="粘贴要添加的信息，一行一个。" Text="{Binding PasteText, Mode=TwoWay}"/>
        <Border Padding="8" BorderBrush="#DDD" BorderThickness="1" CornerRadius="6">
          <Grid ColumnDefinitions="*,*,*,*,*" RowDefinitions="Auto,Auto,Auto,Auto,Auto,Auto" ColumnSpacing="8" RowSpacing="6">
            <TextBlock Text="班级"/>
            <TextBlock Text="学号" Grid.Column="1"/>
            <TextBlock Text="姓名" Grid.Column="2"/>
            <TextBlock Text="原因" Grid.Column="3"/>
            <TextBlock Text="积分" Grid.Column="4"/>
            <ComboBox ItemsSource="{Binding ClassOptions}" SelectedItem="{Binding ClassInput, Mode=TwoWay, UpdateSourceTrigger=LostFocus}" Grid.Row="1"/>
            <TextBox Grid.Column="1" Grid.Row="1" Text="{Binding StudentIdInput, Mode=TwoWay, UpdateSourceTrigger=LostFocus}"/>
            <TextBox Grid.Column="2" Grid.Row="1" Text="{Binding NameInput, Mode=TwoWay, UpdateSourceTrigger=LostFocus}" 
                     Watermark="姓名或拼音（如：张三 或 zhangsan 或 zs）"/>
            <TextBox Grid.Column="3" Grid.Row="1" Text="{Binding ReasonInput, Mode=TwoWay, UpdateSourceTrigger=LostFocus}"/>
            <TextBox Grid.Column="4" Grid.Row="1" Text="{Binding ScoreInput, Mode=TwoWay, UpdateSourceTrigger=LostFocus}"/>
            
            <!-- 积分错误提示 -->
            <TextBlock Grid.Row="2" Grid.Column="4" Text="{Binding ScoreErrorMessage}" 
                       Foreground="Red" FontSize="11" Margin="0,2,0,0" TextWrapping="Wrap"
                       IsVisible="{Binding ScoreErrorMessage, Converter={x:Static ObjectConverters.IsNotNull}}"/>
            
            <!-- 学生匹配信息显示 -->
            <TextBlock Grid.Row="3" Grid.ColumnSpan="5" Text="{Binding MatchedStudentInfo}" 
                       Foreground="Blue" FontSize="12" Margin="0,4,0,0" TextWrapping="Wrap"/>
            
            <!-- 新增教师输入行 -->
            <TextBlock Text="任课教师" Grid.Row="4" Grid.ColumnSpan="2" Margin="0,8,0,0"/>
            <TextBox Grid.Row="5" Grid.ColumnSpan="3" Text="{Binding TeacherInput, Mode=TwoWay, UpdateSourceTrigger=LostFocus}" 
                     Watermark="教师姓名/拼音/科目（如：张老师 或 数学 或 zhanglaoshi）"/>
            <TextBlock Grid.Row="5" Grid.Column="3" Grid.ColumnSpan="2" Text="{Binding MatchedTeacherInfo}" 
                       Foreground="Green" FontSize="12" VerticalAlignment="Center" TextWrapping="Wrap"/>
          </Grid>
        </Border>
      </StackPanel>
      
      <!-- 待处理列表 -->
      <StackPanel Grid.Row="2" Spacing="8">
        <TextBlock Text="待处理列表" FontSize="16" FontWeight="SemiBold"/>
        <Border IsVisible="{Binding !PendingItems.Count}" 
                Padding="8" BorderBrush="#DDD" BorderThickness="1" CornerRadius="6">
          <TextBlock Text="暂无待处理项目" Foreground="#888"/>
        </Border>
        <ScrollViewer Height="150" IsVisible="{Binding !!PendingItems.Count}">
          <ItemsControl ItemsSource="{Binding PendingItems}">
            <ItemsControl.ItemTemplate>
              <DataTemplate x:DataType="core:EvaluationEntry">
                <Border Padding="8,4" BorderBrush="#EEE" BorderThickness="0,0,0,1" Margin="0,2">
                  <Grid ColumnDefinitions="*,Auto,Auto" ColumnSpacing="8">
                    <TextBlock Grid.Column="0" Text="{Binding Remark}" TextWrapping="Wrap" VerticalAlignment="Center"/>
                    <Button Grid.Column="1" Content="处理" FontSize="12" Padding="8,4" 
                            Command="{Binding $parent[UserControl].((vm:InfoEntryViewModel)DataContext).ProcessPendingCommand}" CommandParameter="{Binding}"/>
                    <Button Grid.Column="2" Content="删除" FontSize="12" Padding="8,4" 
                            Command="{Binding $parent[UserControl].((vm:InfoEntryViewModel)DataContext).DeletePendingCommand}" CommandParameter="{Binding}"/>
                  </Grid>
                </Border>
              </DataTemplate>
            </ItemsControl.ItemTemplate>
          </ItemsControl>
        </ScrollViewer>
      </StackPanel>
      
      <StackPanel Grid.Row="3" Orientation="Horizontal" HorizontalAlignment="Right" Spacing="8">
        <Button Content="待处理" Command="{Binding AddToPendingCommand}"/>
        <Button Content="跳过" Command="{Binding SkipCommand}"/>
        <Button Content="下一个" Command="{Binding NextCommand}"/>
      </StackPanel>
    </Grid>
  </ScrollViewer>
</UserControl>
